# Magento 2 entry points

Точки входа - это 4 фронт-контроллера в папке /pub. Все они используют Bootstrap для создания обьектов приложения. Bootstrap загружает все глобальные di.xml файлы модулей. 
Все классы приложений имплементируют интерфейс \Magento\Framework\AppInterface и загружают данные из своих зон. Загрузка происходит в методах launch каждого типа приложения при вызове метода run в точках входа.

### Зоны:
- adminhtml. Точка входа pub/index.php. 
- frontend. Точка входа pub/index.php. 
- base. Используется как фоллбэк для adminhtml и frontend зон.
- crontab. Точка входа pub/cron.php.
- webapi_rest. Точка входа pub/index.php. 
- graphql. Точка входа pub/index.php. 
- webapi_soap. Точка входа pub/index.php. 

Каждый модуль может влиять на одну или несколько зон. Т.е., к примеру, содержать функционал для фронтстора (frontend) и админки (adminhtml). Такой функционал должен быть разделен в модуле. Если аппликейшен в зоне админки - должен загружаться функционал только ее.

### Точки входа в приложения:
<ol>
<li>index.php - запускает приложение \Magento\Framework\App\Http. По имени фронт-контроллера, который берется из url, определяется зона и код зоны. Для фронтстора - это код зоны frontend. Для админки - это код зоны adminhtml. По коду загружаются определенные конфиги приложения для зоны. Затем создается общий для каждой зоны фронт-контроллер, который содержит общую логику для всех экшенов, которые обрабатывают запросы. Фронт-контролер оборачивается в класс Interceptor. Задача фронт-контроллера - задиспатчить запрос на определенный экшен. Для этого берется набор роутов и идет поиск подходящего экшена обработки запроса по урле из запроса. Если такой не найдет, то устанавливается форвард-экшен с именем noroute. Код делает новую итерацию цикла для поиска подходящего класса-экшена для обработки уже noroute. И так не более 100 раз. 
Есть 4 типа роутов: Base Router, CMS Router, UrlRewrite Router, Default Router.
Если экшен найден - вызывается его метод dispatch.
Экшен может не быть задиспатченным, если он в своем коде установит флаг 'no-dispatch'. Например, если засабмиченная форма не прошла валидацию, то экшен может установить этот флаг и форма не будет сохранена в БД.
Типы респонсов, которые может формировать экшен: Page Result, JSON Result, Raw Result, Forward Result, Redirect Result.
Если результат - это объект, имплементирующий Magento\Framework\Controller\ResultInterface, то происходит формирования одного из типов респонса.
Есть различные редиректы. Например, если сессия не валидна - редирект на стартовую страницу. Если мэинтейнс режим - 503 код ответа.

<li>static.php запускает приложение \Magento\Framework\App\StaticResource. Используется для доступа к статическим ресурсам (CSS, JavaScript, картинкам), если они не запаблишены или режим работы стора - дэв. Эта точка входа не используется в продакшен-режиме для снижения нагрузки на сервер. В этом режиме статические ресурсы берутся из папки /pub/static.
В дэфолтном и дэв режимах статические файлы всегда запрашиваются через это точку доступа. 
В дэв-режиме это происходит при любом повторном запросе статического ресурса. Поэтому они всегда в актуальной своей версии. Но также найденный ресурс паблишится в папку pub/static, как и при других режимах работы сайта (дэфолтном и продакшен). Для поиска ресурса парсится url запрашиваемого ресурса. 
В дэфолтном режиме запрошенные и найденные ресурсы помещаются в папку  pub/static. Т.е. при последующих запросах на поиск статического ресурса - он берется из этой папки и таким образом кэшируется.
Для обновления версии ресурса - его необходимо удалить из папки pub/static и заново запросить у сервера.

<li>get.php запускает приложение \Magento\MediaStorage\App\Media. Используется для доступа к медиа ресурсам, если они запрошены для выборки из базы данных, локального хранилища  и не запаблишены или режим работы стора - дэв.
При каждом запросе на эту точку входа генерируется файл var/resource_config.json если его нет или время его жизни естекло. В нем кэшируются параметры доступа к медиа файлам: относительный путь к папке с медиа-ресурсами и массив названий папок, с которых возможно брать медиа ресурс и отдавать в ответе, и время жизни этого файла.
При запросе медиа-ресурса идет проверка на его существование в папке с медиа-ресурсами и возможности доступа к нему, не истелоли время его жизни. Если нет resource_config.json или его врнмя жизни истело, или не разрешен доступ к запрашиваемому ресурсу, или нет самого медиа-файла в папке с медиа-ресурсами - тогда создается приложение и скрипт пытается взять медиа из базы данных и сохранить его в папке pbu/media и перегенерить файл resource_config.json. 
У кэш-файла var/resource_config.json есть время жизни. После его истечения он перегенерируется если запрос на медиа ресурс был переадресован на Media аппликейшен.

Сконфигурировать хранение медиа в базе данных можно в админке:
- Stores > Settings > Configuration
- Advanced > System
- Storage Configuration for Media

Также можно сконфигурировать брать медиа из CDN.  Если в админке установлено - брать медиа из CDN, то при запросе медиа идет запрос на CDN. Если медиа найден - отдается браузеру, если нет - то идет поиск в локальных папках где установлен стор.
Сконфигурировать хранение медиа в CDN можно в админке:
- Stores > Settings > Configuration
- General > Web
- Base URLs
- Base URL for User Media Files

Но эта точка входа не использует CDN для поиска медиа-ресурса.

Если необходимо добавить в var/resource_config.json кастомную разрешенную директорию, то необходимо в файле модуля etc/config.xml добавить ноду. Например,
```xml
<media_storage_configuration>
	<allowed_resources>
        <custom_folder>custom</custom_folder>
    </allowed_resources>
</media_storage_configuration>
```

<li>cron.php запускает приложение \Magento\Framework\App\Cron. Предназначен для запуска крон задач указанной группы через браузер. Например, <домен>\cron.php?[group=<name>].
Должен быть задизейблен доступ к этому скрипту через вэб. Запуск крон-задач происходит через запуск общего скрипта, записанного на запуск раз в минуту в кронтабе или вручную запуском команды php bin/magento cron:run в консоли.
Если все таки надо запуск скрипта из вэба, то необходимо создать пароль и запрашивать его при запуске cron.php. При его запуске происходит установка зоны с кодом crontab. Далее загружаются конфиги этой зоны и инстанциируется объект типа ивент-мэнэджэра и диспатчится ивент с именем default.
Для создания крон задачи необходимо создать в модуле файл crontab.xml. Указать какой группе принадлежит она и какой метод какого класса вызывать и с какой периодичностью.
После диспатча события идет поиск обзерверов (обвертка вокруг каждой крон задачи в файлах crontab.xml) и вызов метода-обработчика события.  Пейлоад ивента в данном случае для всех обработчиков пустой.
